name: 麦当劳优惠券自动领取

on:
  # 每月1日北京时间 00:05 获取活动日历 (UTC 前一天 16:05)
  schedule:
    - cron: '5 16 1 * *'  # 每月1日
    - cron: '5 16 * * *'  # 每天执行（检查是否有活动）
  
  # 支持手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式'
        required: true
        default: 'full'
        type: choice
        options:
          - calendar
          - claim
          - full
  
  # 支持 push 触发（用于测试）
  push:
    branches:
      - main
    paths:
      - '.github/workflows/mcd-auto-claim.yml'
      - 'auto_claim.py'

# 设置权限
permissions:
  contents: write
  pages: write
  id-token: write

# 只允许一个并发部署
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 每月1日获取活动日历
  fetch-calendar:
    if: github.event.schedule == '5 16 1 * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'calendar')
    runs-on: ubuntu-latest
    outputs:
      activity_dates: ${{ steps.calendar.outputs.dates }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 检查 Token 配置
        run: |
          if [ -z "${{ secrets.MCD_TOKEN }}" ]; then
            echo "::error::MCD_TOKEN secret 未配置！请在仓库 Settings > Secrets and variables > Actions 中添加"
            exit 1
          fi
          echo "✓ MCD_TOKEN 已配置"
      
      - name: 获取活动日历
        id: calendar
        env:
          MCD_TOKEN: ${{ secrets.MCD_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_PAGES_URL: ${{ vars.GITHUB_PAGES_URL }}
        run: |
          python auto_claim.py --mode calendar
          
          # 读取日历数据并输出活动日期
          if [ -f calendar_data.json ]; then
            DATES=$(python -c "import json; data=json.load(open('calendar_data.json')); print(json.dumps([a['date'] for a in data.get('activities', [])]))")
            echo "dates=$DATES" >> $GITHUB_OUTPUT
          fi
      
      - name: 保存日历数据
        uses: actions/upload-artifact@v4
        with:
          name: calendar-data
          path: calendar_data.json
          retention-days: 35

  # 每天检查是否有活动并领券
  auto-claim:
    if: |
      github.event.schedule == '5 16 * * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.mode == 'claim' || github.event.inputs.mode == 'full')) ||
      github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: 删除旧的 artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // 获取所有 artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            // 删除旧的 report 和 github-pages artifacts (保留最新的)
            const toDelete = ['report', 'github-pages'];
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              if (toDelete.includes(artifact.name)) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  console.log(`Deleted artifact: ${artifact.name} (ID: ${artifact.id})`);
                  deletedCount++;
                } catch (e) {
                  console.log(`Failed to delete ${artifact.name}: ${e.message}`);
                }
              }
            }
            
            console.log(`Total deleted: ${deletedCount} artifacts`);
      
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 检查 Token 配置
        run: |
          if [ -z "${{ secrets.MCD_TOKEN }}" ]; then
            echo "::error::MCD_TOKEN secret 未配置！"
            echo "请在仓库 Settings > Secrets and variables > Actions > Secrets 中添加以下 secret："
            echo "  - MCD_TOKEN: 麦当劳 MCP 认证令牌（必需）"
            echo "  - TELEGRAM_BOT_TOKEN: Telegram 机器人令牌（可选，用于推送通知）"
            echo "  - TELEGRAM_CHAT_ID: Telegram 聊天 ID（可选，用于推送通知）"
            exit 1
          fi
          echo "✓ MCD_TOKEN 已配置"
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "✓ TELEGRAM_BOT_TOKEN 已配置"
          else
            echo "⚠ TELEGRAM_BOT_TOKEN 未配置（可选）"
          fi
      
      - name: 下载日历数据
        uses: actions/download-artifact@v4
        with:
          name: calendar-data
          path: ./
        continue-on-error: true
      
      - name: 检查今天是否有活动
        id: check
        run: |
          TODAY=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          echo "today=$TODAY"
          
          if [ -f calendar_data.json ]; then
            HAS_ACTIVITY=$(python3 -c "import json; today='$TODAY'; data=json.load(open('calendar_data.json')) if True else {}; dates=[a['date'] for a in data.get('activities', [])]; print('true' if today in dates else 'false')" 2>/dev/null || echo "true")
            echo "has_activity=$HAS_ACTIVITY" >> $GITHUB_OUTPUT
          else
            echo "has_activity=true" >> $GITHUB_OUTPUT
          fi
      
      - name: 自动领取优惠券
        if: steps.check.outputs.has_activity == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        env:
          MCD_TOKEN: ${{ secrets.MCD_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_PAGES_URL: ${{ vars.GITHUB_PAGES_URL }}
        run: |
          MODE="${{ github.event.inputs.mode || 'full' }}"
          echo "运行模式: $MODE"
          python auto_claim.py --mode $MODE
      
      - name: 上传报告
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: index.html
          retention-days: 7
          if-no-files-found: ignore
      
      - name: 准备 Pages 部署
        if: steps.check.outputs.has_activity == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          mkdir -p public
          if [ -f index.html ]; then
            cp index.html public/
          fi
          if [ -f calendar_data.json ]; then
            cp calendar_data.json public/
          fi
          # 确保 public 目录不为空
          if [ ! -f public/index.html ]; then
            echo "<html><body><h1>报告生成中...</h1></body></html>" > public/index.html
          fi
      
      - name: 上传 Pages artifact
        if: steps.check.outputs.has_activity == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  # 部署到 GitHub Pages
  deploy-pages:
    needs: auto-claim
    if: always() && needs.auto-claim.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
